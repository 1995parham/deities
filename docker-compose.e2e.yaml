# Docker Compose for E2E Testing
#
# This setup provides:
# - A local Docker registry
# - A k3s Kubernetes cluster
# - The deities application
#
# Usage:
#   docker compose -f docker-compose.e2e.yaml up -d
#   ./scripts/e2e-test.sh

services:
  # Local Docker Registry
  registry:
    image: registry:2
    container_name: deities-registry
    ports:
      - "5000:5000"
    environment:
      REGISTRY_STORAGE_DELETE_ENABLED: "true"
    volumes:
      - registry-data:/var/lib/registry
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5000/v2/"]
      interval: 5s
      timeout: 3s
      retries: 5

  # k3s Kubernetes cluster
  k3s:
    image: rancher/k3s:v1.31.4-k3s1
    container_name: deities-k3s
    command: server --disable=traefik
    privileged: true
    environment:
      K3S_KUBECONFIG_OUTPUT: /output/kubeconfig.yaml
      K3S_KUBECONFIG_MODE: "644"
    volumes:
      - k3s-output:/output
      - k3s-data:/var/lib/rancher/k3s
    ports:
      - "6443:6443"
    healthcheck:
      test: ["CMD", "kubectl", "get", "nodes"]
      interval: 10s
      timeout: 5s
      retries: 12

  # Wait for k3s to be ready and deploy test resources
  k3s-setup:
    image: rancher/k3s:v1.31.4-k3s1
    container_name: deities-k3s-setup
    depends_on:
      k3s:
        condition: service_healthy
      registry:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        # Wait for kubeconfig
        until [ -f /output/kubeconfig.yaml ]; do sleep 1; done
        export KUBECONFIG=/output/kubeconfig.yaml

        # Fix server address for external access
        sed -i 's/127.0.0.1/k3s/g' /output/kubeconfig.yaml

        # Create test deployment
        kubectl apply -f - <<EOF
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: test-app
          namespace: default
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: test-app
          template:
            metadata:
              labels:
                app: test-app
            spec:
              containers:
              - name: app
                image: registry:5000/test-app:latest
                imagePullPolicy: Always
        EOF

        echo "Setup complete"
    volumes:
      - k3s-output:/output

  # Deities application
  deities:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: deities-app
    depends_on:
      k3s-setup:
        condition: service_completed_successfully
    environment:
      DEITIES_LOGGER__LEVEL: debug
      DEITIES_CONTROLLER__CHECK_INTERVAL: 10s
    volumes:
      - k3s-output:/k3s-output:ro
      - ./e2e/config.toml:/app/config.toml:ro
    command: ["--config", "/app/config.toml"]

volumes:
  registry-data:
  k3s-output:
  k3s-data:

networks:
  default:
    name: deities-e2e
